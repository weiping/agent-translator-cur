# AI SDK é›†æˆå’Œå¼€å‘å®è·µ (v0.4.0æ›´æ–°)

## å·¥å…·è°ƒç”¨å›è°ƒæœºåˆ¶ ğŸ†• (v0.4.0æ–°å¢)

### ToolCallbacksæ¥å£å®šä¹‰
```typescript
export interface ToolCallbacks {
  onStatusUpdate: (status: string) => void;    // å®æ—¶çŠ¶æ€æ›´æ–°
  onToolCall: (toolName: string, args: any) => void;      // å·¥å…·è°ƒç”¨å¼€å§‹
  onToolResult: (toolName: string, result: any) => void;  // å·¥å…·æ‰§è¡Œç»“æœ
}
```

### å¢å¼ºçš„LLMè°ƒç”¨æ¥å£
```typescript
export async function sendMessageToLLM(
  messages: ChatMessage[],
  systemPrompt?: string,
  callbacks?: ToolCallbacks  // ğŸ†• v0.4.0æ–°å¢å›è°ƒå‚æ•°
): Promise<string>
```

### å›è°ƒä½¿ç”¨ç¤ºä¾‹
```typescript
const toolCallbacks: ToolCallbacks = {
  onStatusUpdate: (status: string) => {
    // æ›´æ–°UIçŠ¶æ€æ æ˜¾ç¤º
    setAppState(prev => ({ ...prev, statusMessage: status }));
  },
  onToolCall: (toolName: string, args: any) => {
    // è®°å½•å·¥å…·è°ƒç”¨åˆ°æ¶ˆæ¯å†å²
    const argsStr = JSON.stringify(args, null, 2);
    addMessage(`è°ƒç”¨å·¥å…·: ${toolName}\nå‚æ•°: ${argsStr}`, 'tool-call', toolName, args);
  },
  onToolResult: (toolName: string, result: any) => {
    // è®°å½•å·¥å…·ç»“æœåˆ°æ¶ˆæ¯å†å²
    let resultStr = formatToolResult(result);
    addMessage(resultStr, 'tool-result', toolName);
  }
};

// è°ƒç”¨æ—¶ä¼ å…¥å›è°ƒ
const response = await sendMessageToLLM(chatHistory, systemPrompt, toolCallbacks);
```

## AI SDK é›†æˆæ ‡å‡†

### åŸºç¡€é…ç½®
```
    parameters: z.object({
      param1: z.string().describe('å‚æ•°æè¿°'),
      param2: z.string().url().describe('URLå‚æ•°æè¿°')
    }),
    execute: async ({ param1, param2 }) => {
      // è°ƒç”¨è‡ªå®šä¹‰å·¥å…·å®ç°
      const generator = customTool.call({ param1, param2 }, context);
      const result = await generator.next();
      
      if (result.value?.type === 'error') {
        throw new Error(result.value.data.error);
      }
      
      return result.value?.data || { error: 'æ“ä½œå¤±è´¥' };
    }
  })
};
```

### å¢å¼ºçš„å·¥å…·é›†æˆ ğŸ†• (v0.4.0)
```typescript
// åˆ›å»ºå¸¦å›è°ƒæ”¯æŒçš„å·¥å…·å®šä¹‰
const enhancedAiTools = {
  fileReader: tool({
    description: 'è¯»å–æœ¬åœ°æ–‡æœ¬æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒ .md, .txt, .html ç­‰æ ¼å¼',
    parameters: z.object({
      filePath: z.string().describe('è¦è¯»å–çš„æ–‡ä»¶è·¯å¾„')
    }),
    execute: async ({ filePath }) => {
      // v0.4.0æ–°å¢ï¼šçŠ¶æ€å›è°ƒæ”¯æŒ
      callbacks?.onStatusUpdate(`æ­£åœ¨è¯»å–æ–‡ä»¶: ${filePath}`);
      callbacks?.onToolCall('fileReader', { filePath });
      
      // æ‰§è¡Œè‡ªå®šä¹‰å·¥å…·
      const generator = fileReaderTool.call({ filePath }, context);
      const result = await generator.next();
      
      if (result.value?.type === 'error') {
        const error = result.value.data.error;
        callbacks?.onToolResult('fileReader', { error });
        throw new Error(error);
      }
      
      const toolResult = result.value?.data || { error: 'æ–‡ä»¶è¯»å–å¤±è´¥' };
      callbacks?.onToolResult('fileReader', toolResult);
      callbacks?.onStatusUpdate('æ–‡ä»¶è¯»å–å®Œæˆ');
      
      return toolResult;
    }
  })
};
```

### ç³»ç»Ÿæç¤ºè¯è®¾è®¡
```typescript
const enhancedSystemPrompt = `${basePrompt}

ä½ æ‹¥æœ‰ä»¥ä¸‹å·¥å…·å¯ä»¥ä½¿ç”¨ï¼š

1. fileReader: è¯»å–æœ¬åœ°æ–‡ä»¶å†…å®¹
   - æ”¯æŒçš„æ ¼å¼ï¼š.md, .txt, .html, .htm, .json, .csv, .xml, .yml, .yaml
   - å‚æ•°ï¼šfilePath (æ–‡ä»¶è·¯å¾„)
   - è¿”å›ï¼š{ filename: string, content: string }

2. urlFetcher: æŠ“å–ç½‘é¡µå†…å®¹
   - æ”¯æŒHTTP/HTTPSåè®®çš„ç½‘é¡µ
   - å‚æ•°ï¼šurl (ç½‘é¡µåœ°å€)
   - è¿”å›ï¼š{ url: string, content: string (markdown), title: string }

å½“ç”¨æˆ·è¯¢é—®æ–‡ä»¶å†…å®¹æˆ–æä¾›æ–‡ä»¶è·¯å¾„æ—¶ï¼Œä½¿ç”¨ fileReader å·¥å…·ã€‚
å½“ç”¨æˆ·è¯¢é—®ç½‘é¡µå†…å®¹æˆ–æä¾›ç½‘å€æ—¶ï¼Œä½¿ç”¨ urlFetcher å·¥å…·ã€‚
å·¥å…·è°ƒç”¨åï¼Œè¯·åŸºäºè¿”å›çš„å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚`;
```

## LLM è°ƒç”¨è§„èŒƒ (v0.4.0æ›´æ–°)

### æ ‡å‡†è°ƒç”¨æ¨¡å¼
```typescript
export async function sendMessageToLLM(
  messages: ChatMessage[],
  systemPrompt?: string,
  callbacks?: ToolCallbacks  // ğŸ†• v0.4.0æ–°å¢
): Promise<string> {
  // 1. é…ç½®éªŒè¯
  const configCheck = validateConfig();
  if (!configCheck.isValid) {
    throw new Error(configCheck.error || 'é…ç½®æ— æ•ˆ');
  }

  try {
    // 2. çŠ¶æ€æ›´æ–°
    callbacks?.onStatusUpdate('æ­£åœ¨ç­‰å¾…AIå“åº”...');
    
    // 3. è°ƒç”¨ generateText (ä½¿ç”¨å¢å¼ºçš„å·¥å…·é›†)
    const result = await generateText({
      model: getLanguageModel(),
      system: enhancedSystemPrompt,
      temperature: 0.1,
      messages: messages as CoreMessage[],
      tools: enhancedAiTools,  // ğŸ†• ä½¿ç”¨æ”¯æŒå›è°ƒçš„å·¥å…·
      maxSteps: 3,
    });

    callbacks?.onStatusUpdate('AIå“åº”å®Œæˆ');
    return result.text;
  } catch (error: any) {
    // 4. é”™è¯¯å¤„ç†å’Œåˆ†ç±»
    throw handleLLMError(error);
  }
}
```

### æ¶ˆæ¯æ ¼å¼è½¬æ¢
```typescript
// Appç»„ä»¶ä¸­çš„Messageè½¬æ¢ä¸ºLLMçš„ChatMessage
const chatHistory: ChatMessage[] = [
  ...appState.messages.map(msg => ({
    role: msg.type === 'user' ? 'user' as const : 'assistant' as const,
    content: msg.content
  })),
  {
    role: 'user' as const,
    content: newMessage
  }
];
```

## é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

### åˆ†ç±»é”™è¯¯å¤„ç†
```typescript
function handleLLMError(error: any): Error {
  // APIå¯†é’¥é”™è¯¯
  if (error?.message?.includes('401') || error?.message?.includes('unauthorized')) {
    return new Error('APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ OPENAI_API_KEY');
  }
  
  // ç½‘ç»œè¿æ¥é”™è¯¯
  if (error?.message?.includes('network') || error?.code === 'ENOTFOUND') {
    return new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ OPENAI_BASE_URL');
  }
  
  // é…é¢é™åˆ¶é”™è¯¯
  if (error?.message?.includes('quota') || error?.message?.includes('limit')) {
    return new Error('APIé…é¢ä¸è¶³æˆ–è¶…å‡ºé™åˆ¶ï¼Œè¯·æ£€æŸ¥è´¦æˆ·ä½™é¢');
  }
  
  return new Error(`AIæœåŠ¡è¿æ¥å¤±è´¥: ${error?.message || 'æœªçŸ¥é”™è¯¯'}`);
}
```

### UIå±‚é”™è¯¯å¤„ç†
```typescript
// åœ¨ç»„ä»¶ä¸­çš„é”™è¯¯å¤„ç†
const handleSubmit = async (message: string) => {
  try {
    setAppState(prev => ({
      ...prev,
      isLoading: true,
      statusMessage: 'æ­£åœ¨ä¸AIå¯¹è¯...',
      error: undefined
    }));

    const response = await sendMessageToLLM(chatHistory);
    
    // æˆåŠŸå¤„ç†
    addMessage(response, 'system');
    setAppState(prev => ({
      ...prev,
      isLoading: false,
      statusMessage: 'AIå›å¤å®Œæˆ'
    }));
  } catch (error) {
    // é”™è¯¯å¤„ç†
    setAppState(prev => ({
      ...prev,
      isLoading: false,
      error: error instanceof Error ? error.message : 'ä¸AIæœåŠ¡é€šä¿¡å¤±è´¥'
    }));
  }
};
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### æ¸©åº¦è®¾ç½®
- ç¿»è¯‘ä»»åŠ¡ï¼š`temperature: 0.1` (æ›´ç¡®å®šæ€§)
- åˆ›æ„ä»»åŠ¡ï¼š`temperature: 0.7` (æ›´æœ‰åˆ›é€ æ€§)
- ä»£ç ç”Ÿæˆï¼š`temperature: 0.2` (å¹³è¡¡å‡†ç¡®æ€§å’Œçµæ´»æ€§)

### æœ€å¤§æ­¥æ•°æ§åˆ¶
```typescript
// æ ¹æ®ä»»åŠ¡å¤æ‚åº¦è®¾ç½® maxSteps
const result = await generateText({
  // ç®€å•ä»»åŠ¡ï¼šmaxSteps: 1
  // å·¥å…·è°ƒç”¨ï¼šmaxSteps: 3  
  // å¤æ‚æ¨ç†ï¼šmaxSteps: 5
  maxSteps: 3,
  // ...å…¶ä»–é…ç½®
});
```

### æ¶ˆæ¯å†å²ç®¡ç†
```typescript
// é™åˆ¶å†å²æ¶ˆæ¯é•¿åº¦é¿å…tokenè¶…é™
const limitedHistory = messages.slice(-10); // åªä¿ç•™æœ€è¿‘10æ¡æ¶ˆæ¯
```

## å®‰å…¨æ€§è€ƒè™‘

### APIå¯†é’¥ä¿æŠ¤
- æ°¸è¿œä¸è¦å°†APIå¯†é’¥ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
- ä½¿ç”¨ `.env` æ–‡ä»¶å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- ç¡®ä¿ `.env` æ–‡ä»¶åœ¨ `.gitignore` ä¸­

### è¾“å…¥éªŒè¯
- éªŒè¯ç”¨æˆ·è¾“å…¥é•¿åº¦å’Œæ ¼å¼
- é˜²æ­¢æ³¨å…¥æ”»å‡»
- å¯¹å·¥å…·è°ƒç”¨å‚æ•°è¿›è¡Œä¸¥æ ¼éªŒè¯

### é”™è¯¯ä¿¡æ¯
- ä¸è¦åœ¨é”™è¯¯ä¿¡æ¯ä¸­æš´éœ²æ•æ„Ÿä¿¡æ¯
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—ç”¨äºè°ƒè¯•
