# å·¥å…·è°ƒç”¨çŠ¶æ€ç®¡ç†æŒ‡å— (v0.4.0)

## æ¦‚è¿°
v0.4.0ç‰ˆæœ¬å¼•å…¥äº†å®Œæ•´çš„å·¥å…·è°ƒç”¨çŠ¶æ€ç®¡ç†ç³»ç»Ÿï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿå®æ—¶çœ‹åˆ°AIå·¥å…·çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæå‡é€æ˜åº¦å’Œç”¨æˆ·ä½“éªŒã€‚

## æ ¸å¿ƒæ¶æ„

### ToolCallbacksæ¥å£
```typescript
// å®šä¹‰åœ¨ [src/utils/llm.ts](mdc:src/utils/llm.ts)
export interface ToolCallbacks {
  onStatusUpdate: (status: string) => void;        // çŠ¶æ€æ æ›´æ–°
  onToolCall: (toolName: string, args: any) => void;     // å·¥å…·è°ƒç”¨å¼€å§‹
  onToolResult: (toolName: string, result: any) => void; // å·¥å…·æ‰§è¡Œç»“æœ
}
```

### æ¶ˆæ¯ç±»å‹æ‰©å±•
```typescript
// å®šä¹‰åœ¨ [src/types/index.ts](mdc:src/types/index.ts)
interface Message {
  id: string;
  content: string;
  timestamp: Date;
  type: 'user' | 'system' | 'tool-call' | 'tool-result';  // æ‰©å±•ç±»å‹
  toolName?: string;                                      // å·¥å…·åç§°
  toolArgs?: Record<string, any>;                         // å·¥å…·å‚æ•°
}
```

## å®ç°æ¨¡å¼

### çŠ¶æ€å›è°ƒæ³¨å†Œ
åœ¨ [src/components/App.tsx](mdc:src/components/App.tsx) çš„ `handleSubmit` å‡½æ•°ä¸­æ³¨å†Œå›è°ƒï¼š

```typescript
const toolCallbacks: ToolCallbacks = {
  onStatusUpdate: (status: string) => {
    // å®æ—¶æ›´æ–°çŠ¶æ€æ æ˜¾ç¤º
    setAppState(prev => ({ ...prev, statusMessage: status }));
  },
  
  onToolCall: (toolName: string, args: any) => {
    // è®°å½•å·¥å…·è°ƒç”¨åˆ°æ¶ˆæ¯å†å²
    const argsStr = JSON.stringify(args, null, 2);
    addMessage(`è°ƒç”¨å·¥å…·: ${toolName}\nå‚æ•°: ${argsStr}`, 'tool-call', toolName, args);
  },
  
  onToolResult: (toolName: string, result: any) => {
    // æ ¼å¼åŒ–å¹¶è®°å½•å·¥å…·ç»“æœ
    const resultStr = formatToolResult(result);
    addMessage(resultStr, 'tool-result', toolName);
  }
};
```

### å·¥å…·ç»“æœæ ¼å¼åŒ–
```typescript
function formatToolResult(result: any): string {
  if (result.error) {
    return `âŒ é”™è¯¯: ${result.error}`;
  }
  
  if (result.filename && result.content) {
    return `âœ… æˆåŠŸè¯»å–æ–‡ä»¶: ${result.filename}\nå†…å®¹é•¿åº¦: ${result.content.length} å­—ç¬¦`;
  }
  
  if (result.url && result.title) {
    return `âœ… æˆåŠŸæŠ“å–ç½‘é¡µ: ${result.title}\nåœ°å€: ${result.url}\nå†…å®¹é•¿åº¦: ${result.content?.length || 0} å­—ç¬¦`;
  }
  
  return `âœ… å·¥å…·æ‰§è¡Œå®Œæˆ\nç»“æœ: ${JSON.stringify(result, null, 2)}`;
}
```

## æœ€ä½³å®è·µ

### é”™è¯¯ä¼ æ’­
ç¡®ä¿å·¥å…·æ‰§è¡Œé”™è¯¯èƒ½å¤Ÿæ­£ç¡®ä¼ æ’­åˆ°UIï¼š
```typescript
try {
  // å·¥å…·æ‰§è¡Œé€»è¾‘
} catch (error) {
  const errorMsg = error instanceof Error ? error.message : 'å·¥å…·æ‰§è¡Œå¤±è´¥';
  callbacks?.onToolResult(toolName, { error: errorMsg });
  throw error;  // é‡æ–°æŠ›å‡ºé”™è¯¯
}
```

### çŠ¶æ€ä¸€è‡´æ€§
é¿å…çŠ¶æ€æ›´æ–°ç«äº‰æ¡ä»¶ï¼š
```typescript
// æ­£ç¡®ï¼šä½¿ç”¨å‡½æ•°å¼æ›´æ–°
setAppState(prev => ({ ...prev, statusMessage: status }));

// é”™è¯¯ï¼šç›´æ¥çŠ¶æ€ä¿®æ”¹
setAppState({ ...appState, statusMessage: status });
```

### å†…å­˜ç®¡ç†
é¿å…åœ¨å·¥å…·è°ƒç”¨ä¸­ä¿å­˜å¤§é‡æ•°æ®åˆ°æ¶ˆæ¯å†å²ï¼š
```typescript
// æ­£ç¡®ï¼šåªä¿å­˜æ‘˜è¦ä¿¡æ¯
const resultStr = `âœ… æˆåŠŸè¯»å–æ–‡ä»¶: ${result.filename}\nå†…å®¹é•¿åº¦: ${result.content.length} å­—ç¬¦`;

// é”™è¯¯ï¼šä¿å­˜å®Œæ•´å†…å®¹åˆ°æ¶ˆæ¯å†å²
const resultStr = `æ–‡ä»¶å†…å®¹: ${result.content}`;
```

## çŠ¶æ€æ˜¾ç¤ºè§„èŒƒ

### çŠ¶æ€æ¶ˆæ¯è®¾è®¡åŸåˆ™
1. **æè¿°æ€§**: æ¸…æ¥šè¯´æ˜å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ“ä½œ
2. **å…·ä½“æ€§**: åŒ…å«æ“ä½œçš„ç›®æ ‡å¯¹è±¡ï¼ˆæ–‡ä»¶åã€URLç­‰ï¼‰
3. **è¿›åº¦æ€§**: è¡¨æ˜æ“ä½œçš„å¼€å§‹ã€è¿›è¡Œã€å®ŒæˆçŠ¶æ€
4. **ä¸€è‡´æ€§**: ä½¿ç”¨ç»Ÿä¸€çš„æ ¼å¼å’Œæœ¯è¯­

### çŠ¶æ€æ¶ˆæ¯ç¤ºä¾‹
```typescript
// æ–‡ä»¶è¯»å–å·¥å…·
"æ­£åœ¨è¯»å–æ–‡ä»¶: example.md"     // å¼€å§‹çŠ¶æ€
"æ–‡ä»¶è¯»å–å®Œæˆ"                // å®ŒæˆçŠ¶æ€

// URLæŠ“å–å·¥å…·  
"æ­£åœ¨æŠ“å–ç½‘é¡µ: https://example.com"  // å¼€å§‹çŠ¶æ€
"ç½‘é¡µæŠ“å–å®Œæˆ"                       // å®ŒæˆçŠ¶æ€

// é€šç”¨çŠ¶æ€
"æ­£åœ¨ç­‰å¾…AIå“åº”..."         // AIè°ƒç”¨å¼€å§‹
"AIå“åº”å®Œæˆ"               // AIè°ƒç”¨å®Œæˆ
```

## æ¶ˆæ¯å†å²ç®¡ç†

### æ¶ˆæ¯è¿‡æ»¤ç­–ç•¥
ä¸ºAIå¯¹è¯å‡†å¤‡æ¶ˆæ¯å†å²æ—¶ï¼Œéœ€è¦è¿‡æ»¤æ‰å·¥å…·æ¶ˆæ¯ï¼š

```typescript
const chatHistory: ChatMessage[] = [
  ...appState.messages
    .filter(msg => msg.type === 'user' || msg.type === 'system') // åªåŒ…å«å¯¹è¯æ¶ˆæ¯
    .map(msg => ({
      role: msg.type === 'user' ? 'user' as const : 'assistant' as const,
      content: msg.content
    }))
];
```

### å·¥å…·æ¶ˆæ¯æ¸²æŸ“
åœ¨ [src/components/MessageHistory.tsx](mdc:src/components/MessageHistory.tsx) ä¸­å·®å¼‚åŒ–æ˜¾ç¤ºï¼š

```typescript
const getMessageDisplay = (message: Message) => {
  switch (message.type) {
    case 'tool-call':
      return { icon: 'ğŸ”§', color: 'yellow', label: 'å·¥å…·è°ƒç”¨' };
    case 'tool-result':
      return { icon: 'ğŸ“‹', color: 'magenta', label: 'å·¥å…·ç»“æœ' };
    // ... å…¶ä»–ç±»å‹
  }
};
```

